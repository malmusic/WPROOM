<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aziziyah Room Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'bounce-in': 'bounceIn 0.5s',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'wave': 'wave 1.5s ease-in-out infinite',
                        'spin-slow': 'spin 3s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0', transform: 'translateY(10px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)', opacity: '1' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        wave: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Glassmorphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Gradient text */
        .gradient-text {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }
        
        /* Custom checkbox */
        .custom-checkbox {
            position: relative;
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .custom-checkbox.checked {
            background-color: #0ea5e9;
            border-color: #0ea5e9;
        }
        
        .custom-checkbox.checked:after {
            content: "";
            position: absolute;
            left: 5px;
            top: 1px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        /* Floating animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Wave animation */
        @keyframes wave {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        .animate-wave {
            animation: wave 1.5s ease-in-out infinite;
        }
        
        /* Shimmer effect */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .toast-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .toast-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        /* Custom radio button */
        .custom-radio {
            width: 18px;
            height: 18px;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .custom-radio.checked {
            background-color: #0ea5e9;
            border-color: #0ea5e9;
        }
        
        .custom-radio.checked:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
        }
        
        /* Gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        
        /* Floating blob background */
        .blob {
            position: absolute;
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(56, 189, 248, 0.1) 100%);
            border-radius: 50%;
            filter: blur(60px);
            z-index: -1;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen relative overflow-x-hidden">
    <!-- Floating blobs -->
    <div class="blob -top-20 -left-20"></div>
    <div class="blob bottom-0 right-0"></div>
    
    <!-- Main container -->
    <div class="container mx-auto px-4 py-8 max-w-6xl relative">
        <!-- Auth controls -->
        <div class="absolute top-4 right-4 flex items-center space-x-2" id="authControls">
            <span id="authStatus" class="text-sm text-gray-600">Loading...</span>
            <button id="loginBtn" class="bg-primary-500 text-white px-3 py-1 rounded-full text-sm hidden hover:bg-primary-600 transition-colors">
                <i class="fas fa-sign-in-alt mr-1"></i> Login
            </button>
            <button id="logoutBtn" class="bg-gray-500 text-white px-3 py-1 rounded-full text-sm hidden hover:bg-gray-600 transition-colors">
                <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
        </div>
        
        <!-- Header -->
        <header class="mb-8 text-center">
            <div class="inline-block glass-card px-8 py-4 rounded-2xl shadow-sm mb-4">
                <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-primary-600 to-secondary-500 gradient-text mb-1">
                    <i class="fas fa-home mr-2"></i>Aziziyah Expense Tracker
                </h1>
                <p class="text-gray-600 mt-2">
                    Split expenses fairly among your roommates in Aziziyah
                </p>
            </div>
            
            <!-- Stats cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="glass-card rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-primary-100 text-primary-600 mr-4">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Roommates</p>
                            <h3 class="text-xl font-semibold" id="membersCount">0</h3>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-green-100 text-green-600 mr-4">
                            <i class="fas fa-receipt text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total Expenses</p>
                            <h3 class="text-xl font-semibold" id="totalExpensesCount">SAR0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center">
                        <div class="p-3 rounded-lg bg-amber-100 text-amber-600 mr-4">
                            <i class="fas fa-hand-holding-usd text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Active Debts</p>
                            <h3 class="text-xl font-semibold" id="activeDebtsCount">0</h3>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left column -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Members section -->
                <div class="glass-card rounded-xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-users mr-2 text-primary-600"></i>
                            Roommates
                        </h2>
                        <button id="addMemberBtn" class="text-primary-600 hover:text-primary-800 transition-colors">
                            <i class="fas fa-plus-circle text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="membersList" class="space-y-3 max-h-60 overflow-y-auto">
                        <div class="text-center py-4 text-gray-400">
                            <i class="fas fa-user-friends text-3xl mb-2 animate-wave"></i>
                            <p>No roommates added yet</p>
                        </div>
                    </div>
                    
                    <!-- Add member form -->
                    <div id="addMemberForm" class="mt-4 hidden animate-bounce-in">
                        <div class="flex">
                            <input type="text" id="newMemberName" placeholder="Roommate name"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                   autocomplete="off">
                            <button id="saveMemberBtn" class="bg-primary-600 text-white px-4 py-2 rounded-r-lg hover:bg-primary-700 transition-colors flex items-center">
                                <i class="fas fa-check mr-1"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick add expense (mobile) -->
                <div class="lg:hidden glass-card rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-primary-600"></i>
                        Quick Add
                    </h2>
                    <form id="quickExpenseForm" class="space-y-3">
                        <div class="flex items-center border-b border-gray-200 py-2">
                            <i class="fas fa-tag text-gray-400 mr-2"></i>
                            <input type="text" id="quickExpenseDescription" required
                                   class="w-full px-2 py-1 focus:outline-none" 
                                   placeholder="Description">
                        </div>
                        <div class="flex items-center border-b border-gray-200 py-2">
                            <i class="fas fa-riyal-sign text-gray-400 mr-2"></i>
                            <input type="number" id="quickExpenseAmount" step="0.01" min="0.01" required
                                   class="w-full px-2 py-1 focus:outline-none" 
                                   placeholder="Amount">
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-primary-500 to-primary-700 text-white py-2 px-4 rounded-lg hover:from-primary-600 hover:to-primary-800 transition-all">
                            Add Expense
                        </button>
                    </form>
                </div>
                
                <!-- Recent settlements -->
                <div class="glass-card rounded-xl p-6 shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-handshake mr-2 text-secondary-600"></i>
                        Recent Settlements
                    </h2>
                    <div id="settlementsList" class="space-y-3 max-h-40 overflow-y-auto">
                        <div class="text-center py-4 text-gray-400">
                            <i class="fas fa-exchange-alt text-3xl mb-2"></i>
                            <p>No settlements yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Expenses list -->
                <div class="glass-card rounded-xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-receipt mr-2 text-primary-600"></i>
                            Recent Expenses
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button id="filterAll" class="text-xs bg-primary-100 text-primary-800 px-2 py-1 rounded-full">All</button>
                            <button id="filterThisMonth" class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">Month</button>
                            <button id="filterThisYear" class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">Year</button>
                        </div>
                    </div>
                    
                    <div id="expensesList" class="space-y-3 max-h-[500px] overflow-y-auto">
                        <div class="text-center py-10 text-gray-400" id="noExpensesMessage">
                            <i class="fas fa-receipt text-4xl mb-2 animate-wave"></i>
                            <p>No expenses recorded yet</p>
                            <p class="text-sm mt-1">Add your first expense to get started</p>
                        </div>
                    </div>
                </div>
                
                <!-- Summary section -->
                <div class="glass-card rounded-xl p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-primary-600"></i>
                            Summary & Settlements
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button id="refreshSummary" class="text-primary-600 hover:text-primary-800">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="settleAllBtn" class="text-xs bg-gradient-to-r from-green-500 to-green-700 text-white px-3 py-1 rounded-full hover:from-green-600 hover:to-green-800 transition-all">
                                <i class="fas fa-handshake mr-1"></i> Settle All
                            </button>
                        </div>
                    </div>
                    
                    <div id="summaryList" class="space-y-3">
                        <div class="text-center py-6 text-gray-400">
                            <i class="fas fa-chart-bar text-3xl mb-2"></i>
                            <p>Add expenses to see the summary</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating action button -->
    <div class="fixed bottom-6 right-6 z-10">
        <button id="quickAddExpenseBtn" class="animate-float bg-gradient-to-br from-primary-500 to-primary-700 text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center hover:from-primary-600 hover:to-primary-800 transition-all transform hover:scale-105">
            <i class="fas fa-plus text-2xl"></i>
        </button>
    </div>
    
    <!-- Add Expense Modal -->
    <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 animate-bounce-in">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-lg font-semibold text-gray-800">Add New Expense</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="expenseForm" class="p-4 space-y-4">
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-tag text-gray-400"></i>
                        </div>
                        <input type="text" id="expenseDescription" required
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="What was it for?">
                    </div>
                </div>
                
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-riyal-sign text-gray-400"></i>
                        </div>
                        <input type="number" id="expenseAmount" step="0.01" min="0.01" required
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                </div>
                
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-calendar text-gray-400"></i>
                        </div>
                        <input type="date" id="expenseDate"
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label for="expenseCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-list-alt text-gray-400"></i>
                        </div>
                        <select id="expenseCategory"
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <option value="general">General</option>
                            <option value="food">Food</option>
                            <option value="utilities">Utilities</option>
                            <option value="rent">Rent</option>
                            <option value="transport">Transport</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="paidBy" class="block text-sm font-medium text-gray-700 mb-1">Paid by</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <select id="paidBy" required
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <!-- Members will be added here -->
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Split between</label>
                    <div id="splitBetween" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                        <!-- Members checkboxes will be added here -->
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-2">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-primary-500 to-primary-700 text-white py-2 px-4 rounded-lg hover:from-primary-600 hover:to-primary-800 transition-colors flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> Save Expense
                    </button>
                    <button type="button" id="cancelExpense" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Settlement Modal -->
    <div id="settlementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 animate-bounce-in">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-lg font-semibold text-gray-800">Record Settlement</h3>
                <button id="closeSettlementModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="settlementForm" class="p-4 space-y-4">
                <div>
                    <label for="settlementFrom" class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <select id="settlementFrom" required
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <!-- Members will be added here -->
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="settlementTo" class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <select id="settlementTo" required
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <!-- Members will be added here -->
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="settlementAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-riyal-sign text-gray-400"></i>
                        </div>
                        <input type="number" id="settlementAmount" step="0.01" min="0.01" required
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                </div>
                
                <div>
                    <label for="settlementDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-calendar text-gray-400"></i>
                        </div>
                        <input type="date" id="settlementDate"
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label for="settlementMethod" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-credit-card text-gray-400"></i>
                        </div>
                        <select id="settlementMethod"
                                class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="stc">STC Pay</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-2">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-green-500 to-green-700 text-white py-2 px-4 rounded-lg hover:from-green-600 hover:to-green-800 transition-colors flex items-center justify-center">
                        <i class="fas fa-handshake mr-2"></i> Record Settlement
                    </button>
                    <button type="button" id="cancelSettlement" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 animate-bounce-in">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-lg font-semibold text-gray-800">Login</h3>
                <button id="closeLoginModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="loginForm" class="p-4 space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" required class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" required class="w-full px-3 py-2 border rounded-lg">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-primary-500 to-primary-700 text-white py-2 rounded-lg hover:from-primary-600 hover:to-primary-800 transition-all">
                    Login
                </button>
                <button type="button" id="registerBtn" class="w-full bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                    Register
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase and App Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAA9OHGnBNVaLCgTQvMJxuL1PwbHHurWL0",
            authDomain: "aziziahroom.firebaseapp.com",
            databaseURL: "https://aziziahroom-default-rtdb.firebaseio.com",
            projectId: "aziziahroom",
            storageBucket: "aziziahroom.firebasestorage.app",
            messagingSenderId: "526530367231",
            appId: "1:526530367231:web:68826ae8ed4e13138286ca"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize data with empty arrays
            let members = [];
            let expenses = [];
            let settlements = [];
            let currentUser = null;
            
            // DOM elements
            const membersList = document.getElementById('membersList');
            const addMemberBtn = document.getElementById('addMemberBtn');
            const addMemberForm = document.getElementById('addMemberForm');
            const newMemberName = document.getElementById('newMemberName');
            const saveMemberBtn = document.getElementById('saveMemberBtn');
            const paidBySelect = document.getElementById('paidBy');
            const splitBetween = document.getElementById('splitBetween');
            const expenseForm = document.getElementById('expenseForm');
            const quickExpenseForm = document.getElementById('quickExpenseForm');
            const expensesList = document.getElementById('expensesList');
            const noExpensesMessage = document.getElementById('noExpensesMessage');
            const summaryList = document.getElementById('summaryList');
            const settlementsList = document.getElementById('settlementsList');
            const membersCount = document.getElementById('membersCount');
            const totalExpensesCount = document.getElementById('totalExpensesCount');
            const activeDebtsCount = document.getElementById('activeDebtsCount');
            const filterAll = document.getElementById('filterAll');
            const filterThisMonth = document.getElementById('filterThisMonth');
            const filterThisYear = document.getElementById('filterThisYear');
            const refreshSummary = document.getElementById('refreshSummary');
            const expenseModal = document.getElementById('expenseModal');
            const quickAddExpenseBtn = document.getElementById('quickAddExpenseBtn');
            const closeModal = document.getElementById('closeModal');
            const cancelExpense = document.getElementById('cancelExpense');
            const settlementModal = document.getElementById('settlementModal');
            const settlementForm = document.getElementById('settlementForm');
            const closeSettlementModal = document.getElementById('closeSettlementModal');
            const cancelSettlement = document.getElementById('cancelSettlement');
            const settleAllBtn = document.getElementById('settleAllBtn');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const authStatus = document.getElementById('authStatus');
            const loginModal = document.getElementById('loginModal');
            const closeLoginModal = document.getElementById('closeLoginModal');
            const loginForm = document.getElementById('loginForm');
            const registerBtn = document.getElementById('registerBtn');
            
            // Color palette for member avatars
            const avatarColors = [
                'bg-primary-100 text-primary-800',
                'bg-green-100 text-green-800',
                'bg-amber-100 text-amber-800',
                'bg-purple-100 text-purple-800',
                'bg-pink-100 text-pink-800',
                'bg-indigo-100 text-indigo-800',
                'bg-cyan-100 text-cyan-800',
                'bg-rose-100 text-rose-800'
            ];
            
            // Category icons and colors
            const expenseCategories = {
                general: { icon: 'fa-coins', color: 'bg-gray-100 text-gray-800' },
                food: { icon: 'fa-utensils', color: 'bg-red-100 text-red-800' },
                utilities: { icon: 'fa-bolt', color: 'bg-blue-100 text-blue-800' },
                rent: { icon: 'fa-home', color: 'bg-indigo-100 text-indigo-800' },
                transport: { icon: 'fa-car', color: 'bg-yellow-100 text-yellow-800' },
                entertainment: { icon: 'fa-film', color: 'bg-purple-100 text-purple-800' },
                other: { icon: 'fa-dot-circle', color: 'bg-gray-100 text-gray-800' }
            };
            
            // Authentication state listener
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    // User is signed in
                    loadData();
                    authStatus.textContent = `Logged in as ${user.email}`;
                    loginBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                } else {
                    // No user is signed in
                    authStatus.textContent = 'Not logged in';
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    showLoginModal();
                }
            });

            function showLoginModal() {
                loginModal.classList.remove('hidden');
                document.getElementById('loginEmail').focus();
            }

            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        loginModal.classList.add('hidden');
                        showToast('Logged in successfully', 'success');
                    })
                    .catch(error => {
                        showToast(error.message, 'error');
                    });
            }

            function handleRegister() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showToast('Please enter email and password', 'error');
                    return;
                }
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => {
                        loginModal.classList.add('hidden');
                        showToast('Account created successfully', 'success');
                    })
                    .catch(error => {
                        showToast(error.message, 'error');
                    });
            }

            // Firebase data functions
            function loadData() {
                if (!currentUser) return;
                
                const userId = currentUser.uid;
                const userRef = database.ref(`users/${userId}`);
                
                userRef.on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    members = data.members || [];
                    expenses = data.expenses || [];
                    settlements = data.settlements || [];
                    
                    renderMembers();
                    renderExpenses();
                    renderSettlements();
                    updateStats();
                    renderSummary();
                });
            }

            function saveData() {
                if (!currentUser) return;
                
                const userId = currentUser.uid;
                database.ref(`users/${userId}`).set({
                    members,
                    expenses,
                    settlements
                }).catch(error => {
                    showToast('Error saving data: ' + error.message, 'error');
                });
            }

            // Render functions
            function renderMembers() {
                membersList.innerHTML = '';
                
                if (members.length === 0) {
                    membersList.innerHTML = `
                        <div class="text-center py-4 text-gray-400">
                            <i class="fas fa-user-friends text-3xl mb-2"></i>
                            <p>No roommates added yet</p>
                        </div>
                    `;
                    return;
                }
                
                members.forEach((member, index) => {
                    const colorIndex = index % avatarColors.length;
                    const memberElement = document.createElement('div');
                    memberElement.className = 'flex items-center justify-between bg-white/50 p-3 rounded-lg border border-gray-100';
                    memberElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full ${avatarColors[colorIndex]} flex items-center justify-center mr-3">
                                ${member.name.charAt(0).toUpperCase()}
                            </div>
                            <span class="font-medium">${member.name}</span>
                        </div>
                        <button class="text-gray-400 hover:text-red-500 delete-member" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    membersList.appendChild(memberElement);
                });
                
                // Update members count
                membersCount.textContent = members.length;
                
                // Update paidBy and split between options
                updateMemberSelects();
            }
            
            function renderExpenses(filter = 'all') {
                expensesList.innerHTML = '';
                
                if (expenses.length === 0) {
                    noExpensesMessage.classList.remove('hidden');
                    return;
                }
                
                noExpensesMessage.classList.add('hidden');
                
                // Filter expenses
                let filteredExpenses = [...expenses];
                const now = new Date();
                
                if (filter === 'month') {
                    const thisMonth = now.getMonth();
                    const thisYear = now.getFullYear();
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getMonth() === thisMonth && expenseDate.getFullYear() === thisYear;
                    });
                } else if (filter === 'year') {
                    const thisYear = now.getFullYear();
                    filteredExpenses = filteredExpenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getFullYear() === thisYear;
                    });
                }
                
                if (filteredExpenses.length === 0) {
                    expensesList.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <i class="fas fa-search text-3xl mb-2"></i>
                            <p>No expenses found for this period</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort by date (newest first)
                filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Group by month
                const groupedExpenses = {};
                filteredExpenses.forEach(expense => {
                    const date = new Date(expense.date);
                    const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    
                    if (!groupedExpenses[monthYear]) {
                        groupedExpenses[monthYear] = [];
                    }
                    
                    groupedExpenses[monthYear].push(expense);
                });
                
                // Render grouped expenses
                for (const [monthYear, monthExpenses] of Object.entries(groupedExpenses)) {
                    const monthHeader = document.createElement('div');
                    monthHeader.className = 'sticky top-0 bg-white/90 backdrop-blur-sm z-10 py-2 mb-2 border-b border-gray-200';
                    monthHeader.innerHTML = `
                        <h3 class="font-semibold text-gray-700">${monthYear}</h3>
                    `;
                    expensesList.appendChild(monthHeader);
                    
                    monthExpenses.forEach((expense, index) => {
                        const paidByMember = members.find(m => m.id === expense.paidBy);
                        const category = expenseCategories[expense.category] || expenseCategories.general;
                        
                        const expenseElement = document.createElement('div');
                        expenseElement.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100 hover:shadow-sm transition-shadow';
                        expenseElement.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-lg ${category.color} flex items-center justify-center mr-3">
                                    <i class="fas ${category.icon}"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">${expense.description}</h4>
                                    <p class="text-xs text-gray-500">Paid by ${paidByMember?.name || 'Unknown'} on ${new Date(expense.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-semibold">SAR${expense.amount.toFixed(2)}</span>
                                <button class="block text-xs text-gray-400 hover:text-red-500 delete-expense mt-1" data-index="${index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        expensesList.appendChild(expenseElement);
                    });
                }
            }
            
            function renderSettlements() {
                settlementsList.innerHTML = '';
                
                if (settlements.length === 0) {
                    settlementsList.innerHTML = `
                        <div class="text-center py-4 text-gray-400">
                            <i class="fas fa-exchange-alt text-3xl mb-2"></i>
                            <p>No settlements yet</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort by date (newest first)
                const sortedSettlements = [...settlements].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Show only last 5 settlements
                const recentSettlements = sortedSettlements.slice(0, 5);
                
                recentSettlements.forEach(settlement => {
                    const fromMember = members.find(m => m.id === settlement.from);
                    const toMember = members.find(m => m.id === settlement.to);
                    
                    const settlementElement = document.createElement('div');
                    settlementElement.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100';
                    settlementElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-lg bg-green-100 text-green-800 flex items-center justify-center mr-3">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">${fromMember?.name || 'Unknown'} → ${toMember?.name || 'Unknown'}</h4>
                                <p class="text-xs text-gray-500">${new Date(settlement.date).toLocaleDateString()} • ${settlement.method}</p>
                            </div>
                        </div>
                        <span class="font-semibold">SAR${settlement.amount.toFixed(2)}</span>
                    `;
                    settlementsList.appendChild(settlementElement);
                });
            }
            
            function renderSummary() {
                summaryList.innerHTML = '';
                
                if (members.length === 0 || expenses.length === 0) {
                    summaryList.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <i class="fas fa-chart-bar text-3xl mb-2"></i>
                            <p>Add expenses to see the summary</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate balances
                const balances = calculateBalances();
                
                // Separate debts and credits
                const debts = [];
                const credits = [];
                
                members.forEach(member => {
                    const balance = balances[member.id] || 0;
                    if (balance < 0) {
                        debts.push({ member, amount: Math.abs(balance) });
                    } else if (balance > 0) {
                        credits.push({ member, amount: balance });
                    }
                });
                
                // Update active debts count
                activeDebtsCount.textContent = debts.length;
                
                // Render debts
                if (debts.length > 0) {
                    const debtsHeader = document.createElement('h3');
                    debtsHeader.className = 'font-semibold text-gray-700 mb-2';
                    debtsHeader.textContent = 'Who owes money';
                    summaryList.appendChild(debtsHeader);
                    
                    debts.forEach(debt => {
                        const debtElement = document.createElement('div');
                        debtElement.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100 mb-2';
                        debtElement.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-amber-100 text-amber-800 flex items-center justify-center mr-3">
                                    ${debt.member.name.charAt(0).toUpperCase()}
                                </div>
                                <span class="font-medium">${debt.member.name}</span>
                            </div>
                            <span class="font-semibold text-amber-600">SAR${debt.amount.toFixed(2)}</span>
                        `;
                        summaryList.appendChild(debtElement);
                    });
                }
                
                // Render credits
                if (credits.length > 0) {
                    const creditsHeader = document.createElement('h3');
                    creditsHeader.className = 'font-semibold text-gray-700 mt-4 mb-2';
                    creditsHeader.textContent = 'Who is owed money';
                    summaryList.appendChild(creditsHeader);
                    
                    credits.forEach(credit => {
                        const creditElement = document.createElement('div');
                        creditElement.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100 mb-2';
                        creditElement.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-green-100 text-green-800 flex items-center justify-center mr-3">
                                    ${credit.member.name.charAt(0).toUpperCase()}
                                </div>
                                <span class="font-medium">${credit.member.name}</span>
                            </div>
                            <span class="font-semibold text-green-600">SAR${credit.amount.toFixed(2)}</span>
                        `;
                        summaryList.appendChild(creditElement);
                    });
                }
                
                // Render suggested settlements
                if (debts.length > 0 && credits.length > 0) {
                    const settlementsHeader = document.createElement('h3');
                    settlementsHeader.className = 'font-semibold text-gray-700 mt-4 mb-2';
                    settlementsHeader.textContent = 'Suggested Settlements';
                    summaryList.appendChild(settlementsHeader);
                    
                    // Simple settlement suggestions (could be improved with more complex algorithm)
                    debts.forEach(debt => {
                        credits.forEach(credit => {
                            if (debt.amount > 0 && credit.amount > 0) {
                                const settleAmount = Math.min(debt.amount, credit.amount);
                                
                                const settlementElement = document.createElement('div');
                                settlementElement.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-100 mb-2';
                                settlementElement.innerHTML = `
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full bg-amber-100 text-amber-800 flex items-center justify-center mr-2">
                                            ${debt.member.name.charAt(0).toUpperCase()}
                                        </div>
                                        <i class="fas fa-arrow-right text-gray-400 mx-1"></i>
                                        <div class="w-8 h-8 rounded-full bg-green-100 text-green-800 flex items-center justify-center ml-2">
                                            ${credit.member.name.charAt(0).toUpperCase()}
                                        </div>
                                        <span class="ml-3">${debt.member.name} → ${credit.member.name}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="font-semibold mr-3">SAR${settleAmount.toFixed(2)}</span>
                                        <button class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full hover:bg-green-200 transition-colors settle-btn" 
                                                data-from="${debt.member.id}" data-to="${credit.member.id}" data-amount="${settleAmount}">
                                            <i class="fas fa-handshake mr-1"></i> Settle
                                        </button>
                                    </div>
                                `;
                                summaryList.appendChild(settlementElement);
                                
                                // Update remaining amounts
                                debt.amount -= settleAmount;
                                credit.amount -= settleAmount;
                            }
                        });
                    });
                }
            }
            
            function updateStats() {
                // Update total expenses
                const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                totalExpensesCount.textContent = `SAR${totalExpenses.toFixed(2)}`;
            }
            
            function updateMemberSelects() {
                // Update paidBy select
                paidBySelect.innerHTML = '';
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    paidBySelect.appendChild(option);
                });
                
                // Update split between checkboxes
                splitBetween.innerHTML = '';
                members.forEach(member => {
                    const checkboxContainer = document.createElement('label');
                    checkboxContainer.className = 'flex items-center space-x-2 p-2 hover:bg-gray-100 rounded cursor-pointer';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'hidden';
                    checkbox.value = member.id;
                    checkbox.checked = true;
                    
                    const customCheckbox = document.createElement('div');
                    customCheckbox.className = 'custom-checkbox';
                    if (checkbox.checked) customCheckbox.classList.add('checked');
                    
                    const memberName = document.createElement('span');
                    memberName.textContent = member.name;
                    
                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(customCheckbox);
                    checkboxContainer.appendChild(memberName);
                    
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            customCheckbox.classList.add('checked');
                        } else {
                            customCheckbox.classList.remove('checked');
                        }
                    });
                    
                    splitBetween.appendChild(checkboxContainer);
                });
                
                // Update settlement selects
                const settlementFrom = document.getElementById('settlementFrom');
                const settlementTo = document.getElementById('settlementTo');
                
                settlementFrom.innerHTML = '';
                settlementTo.innerHTML = '';
                
                members.forEach(member => {
                    const optionFrom = document.createElement('option');
                    optionFrom.value = member.id;
                    optionFrom.textContent = member.name;
                    settlementFrom.appendChild(optionFrom);
                    
                    const optionTo = document.createElement('option');
                    optionTo.value = member.id;
                    optionTo.textContent = member.name;
                    settlementTo.appendChild(optionTo);
                });
            }
            
            function calculateBalances() {
                const balances = {};
                
                // Initialize balances
                members.forEach(member => {
                    balances[member.id] = 0;
                });
                
                // Calculate expenses
                expenses.forEach(expense => {
                    const paidBy = expense.paidBy;
                    const splitBetween = expense.splitBetween || [];
                    const amountPerPerson = expense.amount / splitBetween.length;
                    
                    // Add to the person who paid
                    balances[paidBy] += expense.amount;
                    
                    // Subtract from those who should pay
                    splitBetween.forEach(memberId => {
                        balances[memberId] -= amountPerPerson;
                    });
                });
                
                // Calculate settlements
                settlements.forEach(settlement => {
                    balances[settlement.from] -= settlement.amount;
                    balances[settlement.to] += settlement.amount;
                });
                
                return balances;
            }
            
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }

            // Event listeners
            addMemberBtn.addEventListener('click', () => {
                addMemberForm.classList.toggle('hidden');
                if (!addMemberForm.classList.contains('hidden')) {
                    newMemberName.focus();
                }
            });
            
            saveMemberBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const name = newMemberName.value.trim();
                
                if (name === '') {
                    showToast('Please enter a name', 'error');
                    return;
                }
                
                const newMember = {
                    id: Date.now().toString(),
                    name: name
                };
                
                members.push(newMember);
                saveData();
                
                newMemberName.value = '';
                addMemberForm.classList.add('hidden');
                showToast(`${name} added as roommate`, 'success');
            });
            
            membersList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-member') || e.target.parentElement.classList.contains('delete-member')) {
                    const button = e.target.classList.contains('delete-member') ? e.target : e.target.parentElement;
                    const index = button.dataset.index;
                    const member = members[index];
                    
                    if (confirm(`Are you sure you want to remove ${member.name}? This will also remove all their related expenses.`)) {
                        members.splice(index, 1);
                        
                        // Remove expenses paid by this member
                        expenses = expenses.filter(expense => expense.paidBy !== member.id);
                        
                        // Remove settlements involving this member
                        settlements = settlements.filter(settlement => 
                            settlement.from !== member.id && settlement.to !== member.id);
                        
                        saveData();
                        showToast(`${member.name} removed`, 'success');
                    }
                }
            });
            
            quickAddExpenseBtn.addEventListener('click', () => {
                expenseModal.classList.remove('hidden');
                document.getElementById('expenseDescription').focus();
            });
            
            closeModal.addEventListener('click', () => {
                expenseModal.classList.add('hidden');
            });
            
            cancelExpense.addEventListener('click', () => {
                expenseModal.classList.add('hidden');
            });
            
            // Save expense function
            function saveExpense(e) {
                e.preventDefault();
                
                const description = document.getElementById('expenseDescription').value.trim();
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const date = document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0];
                const category = document.getElementById('expenseCategory').value;
                const paidBy = document.getElementById('paidBy').value;
                
                // Get split between members
                const splitBetween = [];
                const checkboxes = document.querySelectorAll('#splitBetween input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    splitBetween.push(checkbox.value);
                });
                
                // Validate inputs
                let isValid = true;
                
                if (description === '') {
                    document.getElementById('expenseDescription').classList.add('border-red-500');
                    isValid = false;
                } else {
                    document.getElementById('expenseDescription').classList.remove('border-red-500');
                }
                
                if (isNaN(amount) || amount <= 0) {
                    document.getElementById('expenseAmount').classList.add('border-red-500');
                    isValid = false;
                } else {
                    document.getElementById('expenseAmount').classList.remove('border-red-500');
                }
                
                if (splitBetween.length === 0) {
                    document.getElementById('splitBetween').classList.add('border', 'border-red-500');
                    isValid = false;
                } else {
                    document.getElementById('splitBetween').classList.remove('border', 'border-red-500');
                }
                
                if (!isValid) {
                    showToast('Please fill all required fields correctly', 'error');
                    return;
                }
                
                const newExpense = {
                    id: Date.now().toString(),
                    description,
                    amount,
                    date,
                    category,
                    paidBy,
                    splitBetween
                };
                
                expenses.push(newExpense);
                saveData();
                
                // Reset form
                expenseForm.reset();
                expenseModal.classList.add('hidden');
                
                showToast('Expense added successfully', 'success');
            }

            // Event listeners
            expenseForm.addEventListener('submit', saveExpense);
            
            quickExpenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const description = document.getElementById('quickExpenseDescription').value.trim();
                const amount = parseFloat(document.getElementById('quickExpenseAmount').value);
                
                if (description === '') {
                    showToast('Please enter a description', 'error');
                    return;
                }
                
                if (isNaN(amount) || amount <= 0) {
                    showToast('Please enter a valid amount', 'error');
                    return;
                }
                
                if (members.length === 0) {
                    showToast('Please add roommates first', 'error');
                    return;
                }
                
                const newExpense = {
                    id: Date.now().toString(),
                    description,
                    amount,
                    date: new Date().toISOString().split('T')[0],
                    category: 'general',
                    paidBy: members[0].id,
                    splitBetween: members.map(m => m.id)
                };
                
                expenses.push(newExpense);
                saveData();
                
                // Reset form
                quickExpenseForm.reset();
                
                showToast('Expense added successfully', 'success');
            });
            
            expensesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-expense') || e.target.parentElement.classList.contains('delete-expense')) {
                    const button = e.target.classList.contains('delete-expense') ? e.target : e.target.parentElement;
                    const index = button.dataset.index;
                    const expense = expenses[index];
                    
                    if (confirm(`Are you sure you want to delete this expense: ${expense.description}?`)) {
                        expenses.splice(index, 1);
                        saveData();
                        showToast('Expense deleted', 'success');
                    }
                }
            });
            
            filterAll.addEventListener('click', () => {
                filterAll.classList.remove('bg-gray-100');
                filterAll.classList.add('bg-primary-100', 'text-primary-800');
                filterThisMonth.classList.remove('bg-primary-100', 'text-primary-800');
                filterThisMonth.classList.add('bg-gray-100');
                filterThisYear.classList.remove('bg-primary-100', 'text-primary-800');
                filterThisYear.classList.add('bg-gray-100');
                renderExpenses('all');
            });
            
            filterThisMonth.addEventListener('click', () => {
                filterThisMonth.classList.remove('bg-gray-100');
                filterThisMonth.classList.add('bg-primary-100', 'text-primary-800');
                filterAll.classList.remove('bg-primary-100', 'text-primary-800');
                filterAll.classList.add('bg-gray-100');
                filterThisYear.classList.remove('bg-primary-100', 'text-primary-800');
                filterThisYear.classList.add('bg-gray-100');
                renderExpenses('month');
            });
            
            filterThisYear.addEventListener('click', () => {
                filterThisYear.classList.remove('bg-gray-100');
                filterThisYear.classList.add('bg-primary-100', 'text-primary-800');
                filterAll.classList.remove('bg-primary-100', 'text-primary-800');
                filterAll.classList.add('bg-gray-100');
                filterThisMonth.classList.remove('bg-primary-100', 'text-primary-800');
                filterThisMonth.classList.add('bg-gray-100');
                renderExpenses('year');
            });
            
            refreshSummary.addEventListener('click', () => {
                renderSummary();
                showToast('Summary refreshed', 'success');
            });
            
            settleAllBtn.addEventListener('click', () => {
                settlementModal.classList.remove('hidden');
                document.getElementById('settlementAmount').focus();
            });
            
            closeSettlementModal.addEventListener('click', () => {
                settlementModal.classList.add('hidden');
            });
            
            cancelSettlement.addEventListener('click', () => {
                settlementModal.classList.add('hidden');
            });
            
            settlementForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const from = document.getElementById('settlementFrom').value;
                const to = document.getElementById('settlementTo').value;
                const amount = parseFloat(document.getElementById('settlementAmount').value);
                const date = document.getElementById('settlementDate').value || new Date().toISOString().split('T')[0];
                const method = document.getElementById('settlementMethod').value;
                
                if (from === to) {
                    showToast('Cannot settle with the same person', 'error');
                    return;
                }
                
                if (isNaN(amount) || amount <= 0) {
                    showToast('Please enter a valid amount', 'error');
                    return;
                }
                
                const newSettlement = {
                    id: Date.now().toString(),
                    from: to,  // Corrected: The person receiving should be 'from'
                    to: from,  // Corrected: The person paying should be 'to'
                    amount,
                    date,
                    method
                };
                
                settlements.push(newSettlement);
                saveData();
                
                // Reset form
                settlementForm.reset();
                settlementModal.classList.add('hidden');
                
                showToast('Settlement recorded', 'success');
            });
            
            summaryList.addEventListener('click', (e) => {
                if (e.target.classList.contains('settle-btn') || e.target.parentElement.classList.contains('settle-btn')) {
                    const button = e.target.classList.contains('settle-btn') ? e.target : e.target.parentElement;
                    const from = button.dataset.from;
                    const to = button.dataset.to;
                    const amount = parseFloat(button.dataset.amount);
                    
                    document.getElementById('settlementFrom').value = from;
                    document.getElementById('settlementTo').value = to;
                    document.getElementById('settlementAmount').value = amount.toFixed(2);
                    
                    settlementModal.classList.remove('hidden');
                }
            });
            
            loginBtn.addEventListener('click', showLoginModal);
            
            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    showToast('Logged out successfully', 'success');
                }).catch(error => {
                    showToast(error.message, 'error');
                });
            });
            
            closeLoginModal.addEventListener('click', () => {
                loginModal.classList.add('hidden');
            });
            
            loginForm.addEventListener('submit', handleLogin);
            
            registerBtn.addEventListener('click', handleRegister);
            
            // Initialize
            updateMemberSelects();
        });
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=Malmusic/azizia-room" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>